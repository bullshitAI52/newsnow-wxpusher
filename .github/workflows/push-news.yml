name: Push News to WxPusher

on:
  schedule:
    # 北京时间 6:00, 12:00, 18:00, 22:00
    # UTC 时间 22:00 (前一天), 4:00, 10:00, 14:00
    - cron: '0 22 * * *'  # 22:00 UTC = 第二天 6:00 CST
    - cron: '0 4 * * *'   # 4:00 UTC = 12:00 CST
    - cron: '0 10 * * *'  # 10:00 UTC = 18:00 CST
    - cron: '0 14 * * *'  # 14:00 UTC = 22:00 CST
  workflow_dispatch:  # 允许手动触发

jobs:
  push-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install pnpm
        run: |
          npm install -g pnpm
          corepack enable
          pnpm --version
          
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          
      - name: Run news push script
        env:
          WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN || 'AT_9UtUjpjLJKXkTzN0G3cYDBcrpXPjNE2J' }}
          WXPUSHER_USER_ID: ${{ secrets.WXPUSHER_USER_ID || 'UID_sPgen3dJSu6TjZ9KVTFKa8aox01o' }}
          BASE_URL: ${{ secrets.BASE_URL || 'https://newsnow.busiyi.world' }}
          # WxPusher配置（保持原样：5个源，每个8条）
          WXPUSHER_SOURCE_IDS: ${{ secrets.WXPUSHER_SOURCE_IDS || 'weibo,zhihu,baidu,bilibili,toutiao' }}
          WXPUSHER_MAX_ITEMS: ${{ secrets.WXPUSHER_MAX_ITEMS || '8' }}
          # Telegram配置（增加：10个源，每个12条）
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_USERNAME: ${{ secrets.TELEGRAM_USERNAME || '@wwyyybbbb' }}
          TELEGRAM_USER_ID: ${{ secrets.TELEGRAM_USER_ID || '7789762624' }}
          TELEGRAM_FIRST_NAME: ${{ secrets.TELEGRAM_FIRST_NAME || 'deed' }}
          TELEGRAM_LAST_NAME: ${{ secrets.TELEGRAM_LAST_NAME || 'Iioooii' }}
          TELEGRAM_LANGUAGE: ${{ secrets.TELEGRAM_LANGUAGE || 'zh-hans' }}
          TELEGRAM_SOURCE_IDS: ${{ secrets.TELEGRAM_SOURCE_IDS || 'weibo,zhihu,baidu,bilibili,toutiao,douyin,hupu,tieba,ithome,github' }}
          TELEGRAM_MAX_ITEMS: ${{ secrets.TELEGRAM_MAX_ITEMS || '12' }}
        run: |
          npx tsx scripts/push-news.ts